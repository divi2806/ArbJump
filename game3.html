<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Survivor: Zombies (Single File)</title>
    <style>
      body {
        margin: 0;
        background: #111;
        color: #ddd;
        font-family: Arial, sans-serif;
        user-select: none; /* Prevent text selection */
      }
      #game-container {
        display: block;
        margin: 0 auto;
      }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />

    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@farcade/game-sdk@0.2.0/dist/index.min.js"></script>
  </head>
  <body>
    <div id="game-container"></div>

    <script>
      // Simple survivor zombie game - single HTML file
      const WIDTH = 360; // Adjusted for 9:16 aspect ratio
      const HEIGHT = 640; // Adjusted for 9:16 aspect ratio
      const MAP_PAD = 1000; // size of playable world (square)

      let cursors, keys;
      let loadingText;
      let player,
        gun,
        bullets,
        lastFired = 0;
      let currentGun = "pistol"; // pistol by default
      let zombies;
      let moneyGroup; // Group for money drops
      let shop, shopMenu, stimmyBtn, shotgunBtn; // Shop menu UI
      let isNearShop = false;
      let navbarBg, madeByText, heartImage, scoreText, cashText, dayNightImage, timerText, waveText; // Updated UI elements
      let health = 5; // Replaced lives with health
      let score = 0;
      let cash = 0; // Added cash variable
      let kills = 0;
      let canBeHit = true;
      let spawnTimer = 0;
      let waveTimer = 0; // New for wave system
      let waveActive = false; // Changed to start in cooldown period
      let waveNumber = 1; // New for tracking wave number
      let gameOver = false;
      let playerContainer; // Container for gun only
      let healthBar; // New health bar graphics
      let joystickBase; // For sticky joystick
      let joystickHandle; // For sticky joystick handle
      let joystickActive = false; // Track joystick state
      let joystickPointerId = null; // Track pointer ID for joystick
      let shopPointerId = null;
      let joystickBaseX; // Declare globally
      let joystickBaseY; // Declare globally
      let maxJoystickDistance = 50; // Maximum distance for joystick
      let rt; // Declare rt globally for access in update
      let startGameHintBg, startGameHintText;
      let endStatsHeading, endStatsText, endContinueBtn, endbg, endbgblack;
      let footstepsTimer = 0;
      let hasPlayedShopVoice = false;
      let hasPlayedDeathscream = false;

      const uiTextStyle = {
        fontFamily: '"Press Start 2P"',
        fontSize: "11px",
        fill: "#ffffff",
      };

      function updateShopBtns() {
        console.log("updating shop btn: " + "$:" + cash + " H:" + health);

        // --- Stimmy Button ---
        if (cash < 10 || health >= 5) {
          stimmyBtn.setTint(0x555555); // greyed out
          stimmyBtn.disableInteractive();
        } else {
          stimmyBtn.clearTint(); // back to normal
          stimmyBtn.setInteractive();
        }

        // --- Shotgun Button ---
        if (cash < 50 || currentGun === "shotgun") {
          shotgunBtn.setTint(0x555555);
          shotgunBtn.disableInteractive();
        } else {
          shotgunBtn.clearTint();
          shotgunBtn.setInteractive();
        }
      }

      let gameTimeMinutes = 9 * 60; // start at 09:00
      let isDay = true; // start in day
      let lastIsDay = true;

      // Rest of the functions remain the same...
      function createCircleTexture(scene, key, radius, fillColor, strokeColor) {
        const g = scene.make.graphics({ x: 0, y: 0, add: false });
        g.fillStyle(fillColor, 1);
        g.fillCircle(radius, radius, radius);
        g.lineStyle(Math.max(2, Math.round(radius * 0.12)), strokeColor, 1);
        g.strokeCircle(radius, radius, radius);
        g.generateTexture(key, radius * 2 + 2, radius * 2 + 2);
        g.destroy();
      }

      function shoot(scene, tx, ty) {
        const now = scene.time.now;
        const fireRate = currentGun === "shotgun" ? 400 : 180; // slower fire rate for shotgun
        if (now - lastFired < fireRate) return;
        lastFired = now;

        const shootSounds = ["pistolshoot1", "pistolshoot2", "pistolshoot3"];

        // Select a random sound effect
        const randomSound = shootSounds[Math.floor(Math.random() * shootSounds.length)];

        // Play the selected sound effect
        scene.sound.play(randomSound, { volume: 0.1 });

        const baseAngle = Phaser.Math.Angle.Between(player.x, player.y, tx, ty);
        const speed = 900;
        const spread = currentGun === "shotgun" ? Phaser.Math.DegToRad(8) : 0; // 8Â° spread

        let bulletCount = currentGun === "shotgun" ? 3 : 1;
        let startOffset = -(bulletCount - 1) / 2; // centers the spread
        let bulletLifetime = currentGun === "shotgun" ? 200 : 300; // shotgun dies faster

        for (let i = 0; i < bulletCount; i++) {
          const angle = baseAngle + (startOffset + i) * spread;
          const offsetX = -Math.sin(angle) - 10;
          const offsetY = Math.cos(angle);

          const bullet = bullets.get(player.x + offsetX, player.y + offsetY, "bullet");
          if (!bullet) continue;

          bullet.setActive(true);
          bullet.setVisible(true);
          bullet.body.reset(player.x + offsetX, player.y + offsetY);
          bullet.setDepth(1);
          bullet.setRotation(angle);

          scene.physics.velocityFromRotation(angle, speed, bullet.body.velocity);

          // Destroy after lifetime
          scene.time.addEvent({
            delay: bulletLifetime,
            callback: () => {
              if (bullet && bullet.body) bullet.destroy();
            },
          });
        }
      }

      function bulletHitsZombie(bullet, zombie) {
        if (!bullet.active || !zombie.active) return;
        bullet.destroy();
        zombie.health -= 1;
        const zombieHitSounds = ["zombiehit1", "zombiehit2", "zombiehit3", "zombiehit4"];

        // Select a random sound effect
        const randomSound = zombieHitSounds[Math.floor(Math.random() * zombieHitSounds.length)];

        // Play the selected sound effect
        this.sound.play(randomSound, { volume: 1 });
        zombie.setTint(0xffffff);
        zombie.scene.time.addEvent({
          delay: 80,
          callback: () => zombie.clearTint(),
        });
        if (zombie.health <= 0) {
          pointsForKill(zombie.scene, zombie);
          this.sound.play("bonecrack", { volume: 0.3 });
          kills++;
        } else {
          const dir = Phaser.Math.Angle.Between(bullet.x, bullet.y, zombie.x, zombie.y);
          zombie.body.velocity.x += Math.cos(dir) * 80;
          zombie.body.velocity.y += Math.sin(dir) * 80;
        }
      }

      function bulletHitsBuilding(bullet, tile) {
        if (!bullet.active) return;
        const p = bullet.scene.add.particles("yellowParticle");
        const emitter = p.createEmitter({
          x: bullet.x,
          y: bullet.y,
          speed: { min: 80, max: 200 },
          angle: { min: 0, max: 360 },
          gravityY: 0,
          lifespan: 400,
          quantity: 12,
          scale: { start: 0.9, end: 0 },
          on: false,
        });
        emitter.explode(12, bullet.x, bullet.y);
        bullet.destroy();
      }

      function zombieHitsPlayer(playerObj, zombie) {
        if (!canBeHit || !zombie.active || !playerObj.active) return;
        canBeHit = false;
        playerObj._invulnTimer = 1200;
        playerObj.setTint(0xff4444);
        health -= 1;
        this.sound.play("playerhit", { volume: 0.5 });
        window.FarcadeSDK.singlePlayer.actions.hapticFeedback();
        zombie.scene.cameras.main.shake(180, 0.01);
        const angle = Phaser.Math.Angle.Between(zombie.x, zombie.y, playerObj.x, playerObj.y);
        playerObj.body.velocity.x += Math.cos(angle) * 180;
        playerObj.body.velocity.y += Math.sin(angle) * 180;
      }

      function spawnZombie(scene) {
        const edge = Phaser.Math.Between(0, 3);
        let x, y;
        const margin = Math.max(WIDTH, HEIGHT) * 0.6;
        if (edge === 0) {
          x = Phaser.Math.Between(player.x - margin, player.x + margin);
          y = player.y - margin - Phaser.Math.Between(80, 220);
        } else if (edge === 1) {
          x = player.x + margin + Phaser.Math.Between(80, 220);
          y = Phaser.Math.Between(player.y - margin, player.y + margin);
        } else if (edge === 2) {
          x = Phaser.Math.Between(player.x - margin, player.x + margin);
          y = player.y + margin + Phaser.Math.Between(80, 220);
        } else {
          x = player.x - margin - Phaser.Math.Between(80, 220);
          y = Phaser.Math.Between(player.y - margin, player.y + margin);
        }

        // Determine zombie type weights by waveNumber
        // The array entries: {type: string, chance: number (weight)}
        // sum of weights doesn't have to be 100, Phaser weighted pick can be normalized
        const zombieTypes = [];

        // Normal zombie is always available
        zombieTypes.push({ type: "normal", weight: 50 });

        // Kid zombie available from wave 1, 30 weight
        if (waveNumber >= 3) {
          zombieTypes.push({ type: "kid", weight: 25 });
        }

        // Big zombie available from wave 4, 15 weight
        if (waveNumber >= 4) {
          zombieTypes.push({ type: "giant", weight: 15 });
        }

        // Fast zombie available from wave 6, 5 weight (rare)
        if (waveNumber >= 5) {
          zombieTypes.push({ type: "female", weight: 10 });
        }

        // Pick zombie type based on weights
        const totalWeight = zombieTypes.reduce((sum, z) => sum + z.weight, 0);
        let pick = Phaser.Math.Between(1, totalWeight);
        let chosenType = "normal"; // fallback

        for (const ztype of zombieTypes) {
          pick -= ztype.weight;
          if (pick <= 0) {
            chosenType = ztype.type;
            break;
          }
        }

        // Spawn zombie based on chosen type
        let z;

        switch (chosenType) {
          case "normal":
            z = scene.physics.add.sprite(x, y, "zombie");
            z.setTexture("zombie"); // normal zombie sprite key.
            z.zombieTypeSpawned = "normal";
            z.health = Phaser.Math.Between(1, 2);
            z.baseSpeed = Phaser.Math.Between(30, 60) + Math.min(60, Math.floor(score / 6)) + waveNumber * 5;
            z.clearTint();
            break;

          case "kid":
            z = scene.physics.add.sprite(x, y, "zombiekid");
            z.setTexture("zombiekid"); // kid zombie sprite key
            z.zombieTypeSpawned = "kid";
            z.health = 1;
            z.baseSpeed = Phaser.Math.Between(50, 70) + Math.min(60, Math.floor(score / 6)) + waveNumber * 6;

            break;

          case "giant":
            z = scene.physics.add.sprite(x, y, "zombiegiant");
            z.setTexture("zombiegiant"); // big zombie sprite key
            z.zombieTypeSpawned = "giant";
            z.health = Phaser.Math.Between(5, 8);
            z.baseSpeed = Phaser.Math.Between(20, 40) + waveNumber * 5;

            break;

          case "female":
            z = scene.physics.add.sprite(x, y, "zombiefemale");
            z.setTexture("zombiefemale"); // fast zombie sprite key
            z.zombieTypeSpawned = "female";
            z.health = 1;
            z.baseSpeed = Phaser.Math.Between(60, 90) + waveNumber * 7;

            break;
        }

        z.setDepth(1);
        z.setCollideWorldBounds(true);
        z.setBounce(0.1);
        z.setMask(scene.zombieMask);
        zombies.add(z);
      }

      function pointsForKill(scene, zombie) {
        const p = scene.add.particles("blood");
        const emitter = p.createEmitter({
          x: zombie.x,
          y: zombie.y,
          speed: { min: 80, max: 200 },
          angle: { min: 0, max: 360 },
          gravityY: 0,
          lifespan: 400,
          quantity: 12,
          scale: { start: 0.9, end: 0 },
          on: false,
        });
        emitter.explode(12, zombie.x, zombie.y);
        if (zombie.zombieTypeSpawned === "normal") score += 5;
        if (zombie.zombieTypeSpawned === "kid") score += 10;
        if (zombie.zombieTypeSpawned === "female") score += 20;
        if (zombie.zombieTypeSpawned === "giant") score += 25;
        const money = moneyGroup.create(zombie.x, zombie.y, "money");
        if (money) {
          money.setDepth(2);
          money.setMask(scene.zombieMask); // Apply the same mask as zombies
          money.play("money-fall");
          money.on("animationcomplete", () => {
            money.anims.stop();
            money.setFrame(4);
          });
        }
        zombie.destroy();
        if (waveActive && Phaser.Math.Between(0, 100) < 18) spawnZombie(scene);
      }

      function collectMoney(player, moneyItem) {
        cash += Phaser.Math.Between(1, 3);
        moneyItem.destroy();
        updateShopBtns();
        this.sound.play("moneypickup", { volume: 0.5 });
      }

      function finishGame(scene) {
        gameOver = true;
        window.FarcadeSDK.singlePlayer.actions.gameOver({ score: score });
      }

      function restart(scene) {
        zombies.clear(true, true);
        bullets.clear(true, true);
        moneyGroup.clear(true, true);
        health = 5;
        score = 0;
        cash = 0;
        kills = 0;
        currentGun = "pistol";
        canBeHit = true;
        gameOver = false;
        waveActive = false; // Changed to start in cooldown on restart
        waveTimer = 0;
        spawnTimer = 0;
        waveNumber = 0;
        gameTimeMinutes = 9 * 60;
        scene.cameras.main.fadeIn(300, 0, 0, 0);
        player.enableBody(true, 0, 0, true, true);
        player.x = 450;
        player.y = 550;
        player.clearTint();
        player._invulnTimer = 0;
        gun.setTexture("gun");
        gun.setOrigin(0.35, 0.5);
        if (playerContainer) playerContainer.setPosition(player.x, player.y);
        if (this.vision) this.vision.setScale(2); // Set vision scale to 2 on restart
        rt.visible = true; // Ensure rt is visible on restart
        dayNightImage.setTexture("sun"); // Reset to sun on restart
        timerText.setText(""); // Clear timer text on restart
        joystickActive = false;
        joystickPointerId = null;
        joystickHandle.setPosition(joystickBaseX, joystickBaseY);
        hasPlayedDeathscream = false;
      }

      class BootScene extends Phaser.Scene {
        constructor() {
          super({ key: "BootScene" });
        }
        preload() {
          // Load splash bg PNG
          this.load.image(
            "splashbg",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/d49b9f90-d0b7-420d-9c69-0758ead52b36/bgsplash-nA7kPSEUIWffulTLvComEAwMCLoSDq.png?EPWH",
          );
          this.load.image(
            "logo",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/d49b9f90-d0b7-420d-9c69-0758ead52b36/logo-OVDlYLdQy6P3jVCZ7bgwQyDJXlpkOd.png?fNSj",
          );
          this.load.image(
            "playbutton",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/d49b9f90-d0b7-420d-9c69-0758ead52b36/playbutton-ira7LCOtNMeOmS1fJAsB826L4M8gPv.png?EL00",
          );

          this.load.audio(
            "splashhit",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/d49b9f90-d0b7-420d-9c69-0758ead52b36/scream-RuiXF9iytmzRnMp2mx3oOWgTmq0vLm.mp3?vVNt",
          );
        }

        create() {
          this.scene.start("LoadingScene");
        }
      }

      class LoadingScene extends Phaser.Scene {
        constructor() {
          super({ key: "LoadingScene" });
        }

        preload() {
          // Load font first
          this.loadFontPromise = document.fonts.load('16px "Press Start 2P"');

          // Optional: Add loading text or bar
          const { width, height } = this.cameras.main;
          this.add
            .image(width / 2, height / 2, "splashbg")
            .setOrigin(0.5)
            .setDepth(0);

          loadingText = this.add
            .text(width / 2, height / 2, "Loading...", {
              fontFamily: '"Press Start 2P"',
              fontSize: "12px",
              fill: "#ffffff",
            })
            .setOrigin(0.5);

          // Load survivor spritesheet
          this.load.spritesheet(
            "survivor",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/survivor32bit-RqyXAMHXt4t7yLOZLWrrt9PSvNYbnF.png?7NiA",
            { frameWidth: 32, frameHeight: 32 },
          );
          // Load gun PNG
          this.load.image(
            "gun",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/gun16-qZAwAK5AGooegvxHDki1pMI0CkOEcW.png?cn7m",
          );
          // Load shotgun PNG
          this.load.image(
            "shotgun",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/shotgun-SifzbyaV7QrLqGYFsaVf3ChB8RvAds.png?ayZN",
          );
          // Load zombie spritesheet
          this.load.spritesheet(
            "zombie",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/zombie-Tajm6hvxSNo1tGy3McDJfprjMbDu5V.png?u5qR",
            { frameWidth: 32, frameHeight: 32 },
          );
          // Load zombiekid spritesheet
          this.load.spritesheet(
            "zombiekid",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/kidzombie-Q5Q69rclaTZP3qCaGKawjkZFyXG4Hp.png?GM1Z",
            { frameWidth: 32, frameHeight: 32 },
          );

          // Load zombiefemale spritesheet
          this.load.spritesheet(
            "zombiefemale",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/femalezombie-PEh2WpFFEwF4ohGJ0E1Z105LotUHhE.png?uBt5",
            { frameWidth: 32, frameHeight: 32 },
          );

          // Load zombiegiant spritesheet
          this.load.spritesheet(
            "zombiegiant",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/giantzombie-gllZQ9D5INrUazh8tpm9zgbDma6HYW.png?0LGo",
            { frameWidth: 32, frameHeight: 32 },
          );

          // Load money spritesheet with corrected URL
          this.load.spritesheet(
            "money",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/money-Ljw95TeNZAss8qg90bGiCnWn1Hrbha.png?fIyq",
            { frameWidth: 16, frameHeight: 16 },
          );

          // Load shop spritesheet with corrected URL
          this.load.spritesheet(
            "shop",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/truckguy-EKmMSt0XgUhqaFEDqMQQeHSehBlhb9.png?s2cZ",
            { frameWidth: 96, frameHeight: 48 },
          );

          // Load radio spritesheet with corrected URL
          this.load.spritesheet(
            "radio",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/radio-27cMtZihsDAJyDWwvzJ9rGUAkBomfm.png?q3eq",
            { frameWidth: 32, frameHeight: 32 },
          );

          // Load shop truck leaving spritesheet with corrected URL
          this.load.spritesheet(
            "shopclose",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/shoptruckleaving-1FToNB9EtVEdIWtIEuEZVT787ZXBNe.png?xQ11",
            { frameWidth: 96, frameHeight: 48 },
          );

          // Load tileset image
          this.load.image(
            "terrainsurvivor",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/terrainsurvivor-tr9cDqoXi3ZsnajJkw63YRA27iwEG7.png?B4eZ",
          );

          // Load navbarbg image
          this.load.image(
            "navbarbg",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/topbarfinal-bPdySb2grp0Sp7z1hZabV29u1kSNqY.png?6FcE",
          );

          // Load shopbg
          this.load.image(
            "shopbg",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/shopbg-vzL64tCxHOmX7nxuP20Xmr7i55aDlf.png?OfTq",
          );

          // Load shopstimmy
          this.load.image(
            "shopstimmy",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/stimmyr-UOikiWqGO7tozwZuYgINshpmlb59sp.png?1Jm2",
          );

          // Load shopshotgun
          this.load.image(
            "shopshotgun",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/shotgunselect-pPNwe52zg9CSybsKrPNvuuZMMvMgsw.png?KI9s",
          );

          // Load tilemap JSON
          this.load.tilemapTiledJSON("map", "https://jsonkeeper.com/b/J1ADX");

          // Create simple textures: bullet with decreased sizes
          createCircleTexture(this, "bullet", 3, 0xffff99, 0xcaa800); // Decreased from 6 to 3
          createCircleTexture(this, "blood", 3, 0xff0000, 0xff0000); // New red texture for blood effect
          createCircleTexture(this, "yellowParticle", 3, 0xffff00, 0xffff00); // New yellow texture for bullet collision
          createCircleTexture(this, "joystickHandleTexture", 20, 0x999999, 0x999999); // New texture for joystick handle

          // Load sun and moon images
          this.load.image(
            "sun",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/sun-2PKsD5TpQoCkxFzHgHAZWDGm4h1ZAG.png?lJCt",
          );
          this.load.image(
            "moon",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/moon-uuAxcauO6OhRLxOTzg1PQp0aM3gvTG.png?ZJXJ",
          );

          // Load heart image
          this.load.image(
            "heart",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/heart-KrXOzbLpzjLTlIKs2Rz6UxoyWfDs7a.png?9oEu",
          );

          // FOG
          this.load.image(
            "vision",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/fowfixed-JI2DInYTvPixjZxn0piXhFRpJdZddx.png?M3cZ",
          );

          // ExitButton
          this.load.image(
            "exitbutton",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/exitbutton-I7LXTbu38lN7HDo2sbUp8Z7eXDKmMh.png?2iX4",
          );

          // Music & SoundFX

          this.load.audio(
            "music",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/horrormusic-N2NeuhKFMSnTEC2QS8mH5i21IpJxT0.mp3?SMuE",
          );

          this.load.audio(
            "zombiehit1",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/zombiehit1-kuLoy9tbmHPelcm3W3HKZhQIiSfjZL.mp3?DZxX",
          );

          this.load.audio(
            "zombiehit2",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/zombiehit2-RKwHbKDgMNAFVXtekazEaU6hXvzVnU.mp3?BTzC",
          );

          this.load.audio(
            "zombiehit3",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/zombiehit3-yFVe9Mw4tKr44vdXBQh0VvBZ20G5Kh.mp3?R1jH",
          );

          this.load.audio(
            "zombiehit4",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/zombiehit4-SLu6q1LsgnWrN1N0oitFQJWN1YwXJd.mp3?3a1v",
          );

          this.load.audio(
            "running",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/Random7-CB1oXa48PhnBwG44dttWvFziEuOQwU.wav?urry",
          );

          this.load.audio(
            "bonecrack",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/bonecrack-DfN5qb0yDW3JUUHT14Z8ohxthh4KKY.mp3?y8BD",
          );

          this.load.audio(
            "pistolshoot1",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/pistol1-Q4qOMUDw6yVjzmgFNgLwF2cxU9YhFI.mp3?ESeG",
          );

          this.load.audio(
            "pistolshoot2",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/pistol2-Utx4Ef7zwd6npjWyTZVHAdAOLxtwdY.mp3?epl3",
          );

          this.load.audio(
            "pistolshoot3",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/pistol3-VYJIImVilGOQWmq6BMrjaDcAtXDg9L.mp3?NvWq",
          );

          this.load.audio(
            "shopkeeper1",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/shopkeeper1-F6KHzhvUueHry2mVqblkw568Xw8MX4.mp3?nGit",
          );

          this.load.audio(
            "shopkeeper2",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/shopkeeper2-vfdkpiVLxKDkCmW3Pl5Ua5r21T5hGK.mp3?kzy1",
          );

          this.load.audio(
            "shopkeeper3",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/shopkeeper3-b9aPyVEqlZqLOuG2Z6l395NBTStVbE.mp3?web2",
          );

          this.load.audio(
            "cashregister",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/cashregister-4AJMBjrLlYxeREwfaKm4oeL5rqY7nE.mp3?FUtb",
          );

          this.load.audio(
            "moneypickup",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/moneypickup-ctCEdsA6PnHHfphHGVURtza5VOoYRN.mp3?UIPR",
          );

          this.load.audio(
            "playerhit",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/playegettinghit-D6HE3AYYHqz7ejMWzi1B16Z1OIcuhN.mp3?tH9K",
          );

          this.load.audio(
            "playerdeath",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/deathscream-4VKlRAbXgXoJ6CvjEXX4CD53eRSTBM.mp3?3cJ1",
          );

          this.load.audio(
            "radiostatic",
            "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/cec49d06-d4f3-41ea-90fc-fe0a5220600e/staticradio-4K6MkKQg6xMFFq3RQQfCbBH32nbdCk.mp3?eWvO",
          );

          // You can also add a loading bar here if you want
          this.load.on("progress", (value) => {
            loadingText.setText(`Loading... ${Math.round(value * 100)}%`);
          });
        }

        async create() {
          const { width, height } = this.cameras.main;
          this.sound.play("splashhit", { volume: 0.7 });
          this.add
            .image(width / 2, height / 2, "splashbg")
            .setOrigin(0.5)
            .setDepth(0);
          // Wait for font to load
          await this.loadFontPromise;

          console.log("Font loaded, starting game...");

          // Optional: remove any loading text/graphics
          if (loadingText) loadingText.destroy();

          const logo = this.add.image(width / 2, height / 2 - 120, "logo").setOrigin(0.5);

          // Add Start button
          const startBtn = this.add
            .image(width / 2, height / 2 + 50, "playbutton")
            .setOrigin(0.5)
            .setInteractive()
            .setScale(1.5);

          startBtn.on("pointerdown", () => {
            if (this.sound.context.state === "suspended") {
              this.sound.context.resume();
            }

            this.sound.play("playerdeath");
            this.scene.start("GameScene");
          });

          this.tweens.add({
            targets: startBtn,
            y: startBtn.y + 5,
            duration: 500,
            ease: "Sine.easeInOut",
            yoyo: true,
            repeat: -1,
          });

          const instructions = this.add
            .text(width / 2, height - 180, "Use arrow keys / joystick to move.\nClick screen to shoot.", {
              fontFamily: '"Press Start 2P"',
              fontSize: "10px",
              fill: "#ffffff",
              align: "center",
              lineSpacing: 6,
            })
            .setOrigin(0.5);

          const instructionstwo = this.add
            .text(
              width / 2,
              height - 130,
              "Collect cash from dead zombies\nto buy health + upgrades during the day.\nKill zombies for points.\nSurvive the nights.",
              {
                fontFamily: '"Press Start 2P"',
                fontSize: "6px",
                fill: "#ffffff",
                align: "center",
                lineSpacing: 6,
              },
            )
            .setOrigin(0.5);
        }
      }

      class GameScene extends Phaser.Scene {
        constructor() {
          super({ key: "GameScene" });
        }

        preload() {
          // Preload all assets here (same as your current preload)
          this.load.scenePlugin(
            "AnimatedTiles",
            "https://raw.githubusercontent.com/nkholski/phaser-animated-tiles/master/dist/AnimatedTiles.js",
            "animatedTiles",
            "animatedTiles",
          );
        }

        create() {
          window.FarcadeSDK.singlePlayer.actions.ready(); // Farcade ready call

          const map = this.make.tilemap({ key: "map" });
          const tileset = map.addTilesetImage("terrainsurvivor", "terrainsurvivor"); // Assuming tileset name matches
          const groundLayer = map.createLayer("Ground", tileset, 0, 0); // Assuming layer name; adjust if needed

          const fenceLayer = map.createLayer("Fence", tileset, 0, 0);
          fenceLayer.setCollisionByProperty({ collides: true });
          const buildingsLayer = map.createLayer("Buildings", tileset, 0, 0).setDepth(3);
          buildingsLayer.setCollisionByProperty({ collides: true });
          const buildingsAbove = map.createLayer("BuildingsAbove", tileset, 0, 0).setDepth(4);
          const treesLayer = map.createLayer("Trees", tileset, 0, 0);
          const signsLayer = map.createLayer("Signs", tileset, 0, 0);
          const fieldsLayer = map.createLayer("Fields", tileset, 0, 0);
          const windmillLayer = map.createLayer("Windmill", tileset, 0, 0);

          const accentsLayer = map.createLayer("Accents", tileset, 0, 0);
          const carsLayer = map.createLayer("Cars", tileset, 0, 0);
          carsLayer.setCollisionByProperty({ collides: true });

          this.animatedTiles.init(map);

          this.cameras.main.setBounds(0, 0, map.widthInPixels, map.heightInPixels);
          this.physics.world.setBounds(0, 0, map.widthInPixels, map.heightInPixels);

          // Player sprite (physics enabled) using survivor spritesheet
          player = this.physics.add.sprite(0, 0, "survivor");
          player.setCollideWorldBounds(true);
          player.speed = 260;
          player.setDepth(2);
          player.setPosition(450, 550);

          // Create gun sprite and container
          playerContainer = this.add.container(player.x, player.y); // Create container at player's initial position
          gun = this.add.sprite(7, 15, "gun"); // Create gun at local (0, 0) relative to container
          gun.setDepth(5); // Ensure gun is above player
          gun.setOrigin(0.35, 0.5);
          playerContainer.add(gun); // Add only gun to container
          playerContainer.setDepth(3);

          // Create animation for radio
          this.anims.create({
            key: "radio-anim",
            frames: this.anims.generateFrameNumbers("radio", {
              start: 0,
              end: 1,
            }), // Frames 0-2 for shop anim
            frameRate: 10,
            repeat: -1,
          });

          // Create animation for shop
          this.anims.create({
            key: "shop-anim",
            frames: this.anims.generateFrameNumbers("shop", {
              start: 0,
              end: 2,
            }), // Frames 0-2 for shop anim
            frameRate: 10,
            repeat: -1,
          });

          this.anims.create({
            key: "shop-anim-close",
            frames: this.anims.generateFrameNumbers("shopclose", {
              start: 0,
              end: 8,
            }), // Frames 0-8 for shop anim leaving
            frameRate: 10,
            repeat: 0,
          });

          this.anims.create({
            key: "shop-anim-open",
            frames: this.anims.generateFrameNumbers("shopclose", {
              start: 0,
              end: 8,
            }), // Frames 0-8 for shop anim leaving
            frameRate: 10,
            repeat: 0,
            inReverse: true,
          });

          // Create shop
          shop = this.physics.add.sprite(620, 470, "shop").setDepth(2);
          shop.anims.play("shop-anim");
          shop.setImmovable(true);

          // Overlap check sets `isNearShop`
          this.physics.add.overlap(
            player,
            shop,
            () => {
              if (isDay) {
                isNearShop = true;
                const shopkeeperSounds = ["shopkeeper1", "shopkeeper2", "shopkeeper3"];

                // Select a random sound effect
                const randomSound = shopkeeperSounds[Math.floor(Math.random() * shopkeeperSounds.length)];

                if (!hasPlayedShopVoice) {
                  // Play the selected sound effect
                  this.sound.play(randomSound, { volume: 0.5 });
                  hasPlayedShopVoice = true; // Set the flag to true
                }
              }
            },
            null,
            this,
          );

          // Create animations for survivor spritesheet
          this.anims.create({
            key: "up",
            frames: this.anims.generateFrameNumbers("survivor", {
              start: 0,
              end: 2,
            }),
            frameRate: 10,
            repeat: -1,
          });
          this.anims.create({
            key: "down",
            frames: this.anims.generateFrameNumbers("survivor", {
              start: 3,
              end: 5,
            }),
            frameRate: 10,
            repeat: -1,
          });
          this.anims.create({
            key: "right",
            frames: this.anims.generateFrameNumbers("survivor", {
              start: 6,
              end: 8,
            }),
            frameRate: 10,
            repeat: -1,
          });
          this.anims.create({
            key: "left",
            frames: this.anims.generateFrameNumbers("survivor", {
              start: 9,
              end: 11,
            }),
            frameRate: 10,
            repeat: -1,
          });

          // Create animations for zombie spritesheet
          this.anims.create({
            key: "zombie-up",
            frames: this.anims.generateFrameNumbers("zombie", {
              start: 0,
              end: 2,
            }), // Frames 0-2 for up
            frameRate: 10,
            repeat: -1,
          });
          this.anims.create({
            key: "zombie-down",
            frames: this.anims.generateFrameNumbers("zombie", {
              start: 3,
              end: 5,
            }), // Frames 3-5 for down
            frameRate: 10,
            repeat: -1,
          });
          this.anims.create({
            key: "zombie-left",
            frames: this.anims.generateFrameNumbers("zombie", {
              start: 6,
              end: 8,
            }), // Frames 6-8 for left
            frameRate: 10,
            repeat: -1,
          });
          this.anims.create({
            key: "zombie-right",
            frames: this.anims.generateFrameNumbers("zombie", {
              start: 9,
              end: 11,
            }), // Frames 9-11 for right
            frameRate: 10,
            repeat: -1,
          });

          // Create animations for zombiekid spritesheet
          this.anims.create({
            key: "zombiekid-up",
            frames: this.anims.generateFrameNumbers("zombiekid", {
              start: 0,
              end: 2,
            }), // Frames 0-2 for up
            frameRate: 10,
            repeat: -1,
          });
          this.anims.create({
            key: "zombiekid-down",
            frames: this.anims.generateFrameNumbers("zombiekid", {
              start: 3,
              end: 5,
            }), // Frames 3-5 for down
            frameRate: 10,
            repeat: -1,
          });
          this.anims.create({
            key: "zombiekid-left",
            frames: this.anims.generateFrameNumbers("zombiekid", {
              start: 6,
              end: 8,
            }), // Frames 6-8 for left
            frameRate: 10,
            repeat: -1,
          });
          this.anims.create({
            key: "zombiekid-right",
            frames: this.anims.generateFrameNumbers("zombiekid", {
              start: 9,
              end: 11,
            }), // Frames 9-11 for right
            frameRate: 10,
            repeat: -1,
          });

          // Create animations for zombiekid spritesheet
          this.anims.create({
            key: "zombiefemale-up",
            frames: this.anims.generateFrameNumbers("zombiefemale", {
              start: 0,
              end: 2,
            }), // Frames 0-2 for up
            frameRate: 10,
            repeat: -1,
          });
          this.anims.create({
            key: "zombiefemale-down",
            frames: this.anims.generateFrameNumbers("zombiefemale", {
              start: 3,
              end: 5,
            }), // Frames 3-5 for down
            frameRate: 10,
            repeat: -1,
          });
          this.anims.create({
            key: "zombiefemale-left",
            frames: this.anims.generateFrameNumbers("zombiefemale", {
              start: 6,
              end: 8,
            }), // Frames 6-8 for left
            frameRate: 10,
            repeat: -1,
          });
          this.anims.create({
            key: "zombiefemale-right",
            frames: this.anims.generateFrameNumbers("zombiefemale", {
              start: 9,
              end: 11,
            }), // Frames 9-11 for right
            frameRate: 10,
            repeat: -1,
          });

          // Create animations for zombie spritesheet
          this.anims.create({
            key: "zombiegiant-up",
            frames: this.anims.generateFrameNumbers("zombiegiant", {
              start: 0,
              end: 2,
            }), // Frames 0-2 for up
            frameRate: 10,
            repeat: -1,
          });
          this.anims.create({
            key: "zombiegiant-down",
            frames: this.anims.generateFrameNumbers("zombiegiant", {
              start: 3,
              end: 5,
            }), // Frames 3-5 for down
            frameRate: 10,
            repeat: -1,
          });
          this.anims.create({
            key: "zombiegiant-left",
            frames: this.anims.generateFrameNumbers("zombiegiant", {
              start: 6,
              end: 8,
            }), // Frames 6-8 for left
            frameRate: 10,
            repeat: -1,
          });
          this.anims.create({
            key: "zombiegiant-right",
            frames: this.anims.generateFrameNumbers("zombiegiant", {
              start: 9,
              end: 11,
            }), // Frames 9-11 for right
            frameRate: 10,
            repeat: -1,
          });

          // Create animation for money
          this.anims.create({
            key: "money-fall",
            frames: this.anims.generateFrameNumbers("money", {
              start: 0,
              end: 3,
            }), // Frames 0-3 for falling
            frameRate: 10,
            repeat: 0,
          });

          // bullets group
          bullets = this.physics.add.group({
            classType: Phaser.Physics.Arcade.Image,
            maxSize: 40,
            runChildUpdate: true,
          });

          // zombies group
          zombies = this.physics.add.group();

          this.physics.add.collider(player, buildingsLayer); // Ensuring player collides with buildings layer
          this.physics.add.collider(player, fenceLayer); // Ensuring player collides with buildings layer
          this.physics.add.collider(player, carsLayer); // Ensuring player collides with buildings layer

          this.physics.add.collider(zombies, buildingsLayer);
          this.physics.add.collider(zombies, fenceLayer);
          this.physics.add.collider(zombies, carsLayer);

          // Add collision for bullets with Layera
          this.physics.add.collider(bullets, buildingsLayer, bulletHitsBuilding, null, this);
          this.physics.add.collider(bullets, fenceLayer, bulletHitsBuilding, null, this);
          this.physics.add.collider(bullets, carsLayer, bulletHitsBuilding, null, this);

          // Money group
          moneyGroup = this.physics.add.group();

          // Camera follow with increased initial zoom
          this.cameras.main.startFollow(player);

          // Controls
          cursors = this.input.keyboard.createCursorKeys();
          keys = this.input.keyboard.addKeys("W,A,S,D,R");
          this.input.addPointer(3);

          // --- JOYSTICK SETUP ---
          joystickBaseX = 70;
          joystickBaseY = HEIGHT - 70;
          maxJoystickDistance = 40;

          // Joystick visuals
          const graphics = this.add.graphics();
          graphics.fillStyle(0x666666, 0.5);
          graphics.fillCircle(joystickBaseX, joystickBaseY, 40).setScrollFactor(0).setDepth(100);

          joystickHandle = this.add
            .sprite(joystickBaseX, joystickBaseY, "joystickHandleTexture")
            .setScrollFactor(0)
            .setTint(0x999999)
            .setDisplaySize(35, 35)
            .setDepth(100);

          // Joystick touch area
          const joystickZone = this.add
            .zone(joystickBaseX - 70, joystickBaseY - 70, 150, 150)
            .setOrigin(0, 0)
            .setInteractive()
            .setScrollFactor(0);

          joystickZone.on("pointerdown", (pointer) => {
            joystickActive = true;
            joystickPointerId = pointer.id;
            joystickHandle.setPosition(pointer.x, pointer.y);
          });

          this.input.on("pointermove", (pointer) => {
            if (joystickActive && pointer.id === joystickPointerId) {
              const dx = pointer.x - joystickBaseX;
              const dy = pointer.y - joystickBaseY;
              const distance = Math.min(Math.hypot(dx, dy), maxJoystickDistance);
              const angle = Math.atan2(dy, dx);

              joystickHandle.x = joystickBaseX + Math.cos(angle) * distance;
              joystickHandle.y = joystickBaseY + Math.sin(angle) * distance;

              player.setVelocity(Math.cos(angle) * distance * 4, Math.sin(angle) * distance * 4);
            }
          });

          this.input.on("pointerup", (pointer) => {
            if (pointer.id === joystickPointerId) {
              joystickActive = false;
              joystickPointerId = null;
              joystickHandle.setPosition(joystickBaseX, joystickBaseY);
              player.setVelocity(0, 0);
            }
          });

          // --- SHOP MENU ---
          shopMenu = this.add.container(0, 0).setScrollFactor(0).setDepth(20);

          const bg = this.add
            .image(WIDTH / 2, HEIGHT / 2, "shopbg")
            .setDepth(10)
            .setDisplaySize(240, 180);

          const title = this.add
            .text(WIDTH / 2, HEIGHT / 2 - 50, "Todays Menu", {
              fontFamily: '"Press Start 2P"',
              fontSize: "16px",
              fill: "#ffffff",
            })
            .setOrigin(0.5);

          stimmyBtn = this.add
            .image(132, HEIGHT / 2 + 10, "shopstimmy")
            .setDepth(100)
            .setDisplaySize(80, 80)
            .setOrigin(0.5)
            .setScrollFactor(0)
            .setInteractive();

          const stimmyCost = this.add
            .text(110, HEIGHT / 2 - 17, "$10", {
              fontFamily: '"Press Start 2P"',
              fontSize: "10px",
              fill: "#00ff00",
              align: "center",
            })
            .setOrigin(0.5)
            .setScrollFactor(0)
            .setDepth(101);

          const stimmyText = this.add
            .text(130, HEIGHT / 2 + 60, "+1 HEALTH", {
              fontFamily: '"Press Start 2P"',
              fontSize: "8px",
              fill: "#ff0000",
              align: "center",
            })
            .setOrigin(0.5)
            .setScrollFactor(0)
            .setDepth(101);

          stimmyBtn.on("pointerdown", () => {
            console.log("Stimmy button clicked!");
            if (cash >= 10 && health < 5) {
              cash -= 10;
              cashText.setText("$" + cash);
              console.log("Buying stimmy!");
              health++;
              updateShopBtns();
              this.sound.play("cashregister", { volume: 0.5 });
            } else {
              console.log("Not enough cash! or health already full");
            }
          });

          shotgunBtn = this.add
            .image(230, HEIGHT / 2 + 10, "shopshotgun")
            .setDepth(100)
            .setDisplaySize(80, 80)
            .setOrigin(0.5)
            .setScrollFactor(0)
            .setInteractive();

          shotgunBtn.on("pointerdown", () => {
            console.log("Shotgun button clicked!");
            if (cash >= 50) {
              cash -= 50;
              cashText.setText("$" + cash);
              console.log("Buying shotgun!");

              currentGun = "shotgun"; // switch weapon
              gun.setOrigin(0.2, 0.5);
              gun.setTexture("shotgun"); // swap sprite
              updateShopBtns();
              this.sound.play("cashregister", { volume: 0.5 });
            } else {
              console.log("Not enough cash!");
            }
          });

          const shotgunCost = this.add
            .text(212, HEIGHT / 2 - 17, "$50", {
              fontFamily: '"Press Start 2P"',
              fontSize: "10px",
              fill: "#00ff00",
              align: "center",
            })
            .setOrigin(0.5)
            .setScrollFactor(0)
            .setDepth(101);

          const shotgunText = this.add
            .text(228, HEIGHT / 2 + 60, "SHOTGUN", {
              fontFamily: '"Press Start 2P"',
              fontSize: "8px",
              fill: "#ff0000",
              align: "center",
            })
            .setOrigin(0.5)
            .setScrollFactor(0)
            .setDepth(101);

          shopMenu.add([bg, title, stimmyCost, stimmyText, shotgunCost, shotgunText]);

          // --- SHOOTING HANDLER ---
          this.input.on("pointerdown", (pointer, currentlyOver) => {
            // Ignore joystick
            if (pointer.id === joystickPointerId) return;

            // Ignore clicks on shop items
            if (shopMenu.visible && stimmyBtn.visible && currentlyOver.length > 0) {
              return; // Don't even try to shoot if clicking shop
            }

            // Only shoot if shop closed
            if (!gameOver && !shopMenu.visible && !stimmyBtn.visible) {
              shoot(this, pointer.worldX, pointer.worldY);
            }
          });

          // Collisions
          this.physics.add.overlap(bullets, zombies, bulletHitsZombie, null, this);
          this.physics.add.overlap(player, zombies, zombieHitsPlayer, null, this);

          this.physics.add.overlap(player, moneyGroup, collectMoney, null, this);

          // UI

          navbarBg = this.add
            .image(WIDTH / 2, 50, "navbarbg")
            .setScrollFactor(0)
            .setDepth(10)
            .setDisplaySize(360, 112);
          madeByText = this.add
            .text(8, HEIGHT - 12, "Made by Divyansh_2824", {
              fontFamily: '"Press Start 2P"',
              fontSize: "6px",
              fill: "#ffffff",
            })
            .setScrollFactor(0)
            .setDepth(10);
          heartImage = this.add
            .image(14, 46, "heart") // heart image
            .setScrollFactor(0)
            .setDepth(100)
            .setDisplaySize(20, 15); // Adjust size as needed
          scoreText = this.add
            .text(6, 60, "Score:" + score, uiTextStyle)
            .setScrollFactor(0)
            .setDepth(10);
          cashText = this.add // Added cash text
            .text(6, 78, "$" + cash, uiTextStyle)
            .setScrollFactor(0)
            .setDepth(10);
          healthBar = this.add.graphics(); // Create health bar graphics
          healthBar.setScrollFactor(0);
          healthBar.setDepth(10);

          // Add day/night image and timer text in top right
          dayNightImage = this.add
            .image(WIDTH - 80, 66, "moon") // Initial set to sun
            .setScrollFactor(0)
            .setDepth(10)
            .setDisplaySize(20, 20); // Adjust size as needed
          timerText = this.add
            .text(WIDTH - 34, 66, "", uiTextStyle)
            .setScrollFactor(0)
            .setDepth(10)
            .setOrigin(0.5);

          waveText = this.add
            .text(WIDTH - 40, 46, `${isDay ? "Day" : "Wave"}: ${waveNumber}`, uiTextStyle)
            .setScrollFactor(0)
            .setDepth(10)
            .setOrigin(0.5);

          rt = this.make.renderTexture({
            x: 0,
            y: 0,
            width: map.widthInPixels,
            height: map.heightInPixels,
            add: true,
          });

          // fill it with black
          rt.fill(0x000000, 1);

          // draw the floorLayer into it
          rt.draw(groundLayer);

          // set a dark blue tint
          rt.setTint(0x0a2948);

          const vision = this.make.image({
            x: player.x,
            y: player.y,
            key: "vision",
            add: false,
          });

          this.vision = vision; // Assign to scene for access in update
          this.vision.setScale(2).setDepth(5); // Set initial scale to 2
          this.fogMask = new Phaser.Display.Masks.BitmapMask(this, vision); // Store mask as scene property for fog
          this.fogMask.invertAlpha = true; // Invert for fog rendering
          rt.mask = this.fogMask;

          this.zombieMask = new Phaser.Display.Masks.BitmapMask(this, vision); // New mask for zombies, not inverted
          this.zombieMask.invertAlpha = false; // Opposite inversion for zombies
          buildingsLayer.mask = this.zombieMask;
          buildingsAbove.mask = this.zombieMask;
          shop.mask = this.zombieMask;

          const radio = this.physics.add
            .sprite(WIDTH - 20, HEIGHT - 40, "radio")
            .setDepth(2)
            .setScrollFactor(0);
          radio.anims.play("radio-anim");
          // Start game hint
          startGameHintText = this.add
            .text(WIDTH - 20, HEIGHT - 40, "", {
              fontFamily: '"Press Start 2P"',
              fontSize: "11px",
              fill: "#ffffff",
              align: "right",
              lineSpacing: 6,
            })
            .setScrollFactor(0)
            .setOrigin(1, 1);

          // The text to be typed
          const hintMessage = "The days are short.\nNight's are long.\nSurvive!";

          // Typing effect
          let index = 0;
          const typeInterval = this.time.addEvent({
            delay: 100, // Delay between each character
            callback: () => {
              if (index < hintMessage.length) {
                startGameHintText.setText(hintMessage.substring(0, index + 1));
                index++;
              } else {
                typeInterval.destroy(); // Stop the typing effect
                this.tweens.add({
                  targets: { radio, startGameHintText },
                  alpha: 0,
                  duration: 2000,
                  onComplete: () => {
                    startGameHintText.destroy(); // Remove the text from the scene
                    radio.destroy();
                  },
                }); // Start the fade out effect
              }
            },
            callbackScope: this,
            loop: true,
          });

          this.sound.play("radiostatic", { volume: 0.5 });

          // End screen creation
          endbgblack = this.add
            .rectangle(0, 0, WIDTH, HEIGHT, 0x000000, 0.9)
            .setOrigin(0)
            .setScrollFactor(0)
            .setDepth(4999)
            .setVisible(false);

          endbg = this.add
            .image(WIDTH / 2, HEIGHT / 2, "shopbg")
            .setOrigin(0.5)
            .setDepth(5000)
            .setScrollFactor(0)
            .setDisplaySize(240, 290)
            .setVisible(false);

          // Display player stats
          endStatsHeading = this.add
            .text(WIDTH / 2, HEIGHT / 2 - 75, "LITTLE UNDEAD\nREPORT", {
              fontFamily: '"Press Start 2P"',
              fontSize: "14px",
              fill: "#ffffff",
              align: "center",
              lineSpacing: 6,
            })
            .setOrigin(0.5)
            .setDepth(5001)
            .setScrollFactor(0)
            .setVisible(false);

          endStatsText = this.add
            .text(
              WIDTH / 2 - 5,
              HEIGHT / 2 + 10,
              `Score: ${score}\nSurvived:${waveNumber} days\nKills:${kills}\nCash: ${cash}\nWeapon: ${currentGun}`,
              {
                fontFamily: '"Press Start 2P"',
                fontSize: "10px",
                fill: "#ffffff",
                align: "left",
                lineSpacing: 9,
              },
            )
            .setOrigin(0.5)
            .setDepth(5002)
            .setScrollFactor(0)
            .setVisible(false);

          // Add Continue button
          endContinueBtn = this.add
            .image(WIDTH / 2, HEIGHT / 2 + 90, "exitbutton")
            .setOrigin(0.5)
            .setInteractive()
            .setScale(1.2)
            .setDepth(5001)
            .setScrollFactor(0)
            .setVisible(false);

          endContinueBtn.on("pointerdown", () => {
            endStatsText.setVisible(false);
            endStatsHeading.setVisible(false);
            endContinueBtn.setVisible(false);
            endbgblack.setVisible(false);
            endbg.setVisible(false);
            finishGame(this);
          });

          // Add subtle bobbing effect to the continue button
          this.tweens.add({
            targets: endContinueBtn,
            y: endContinueBtn.y + 3,
            duration: 1000,
            ease: "Sine.easeInOut",
            yoyo: true,
            repeat: -1,
          });

          // Add Farcade event listeners
          window.FarcadeSDK.on("play_again", () => {
            restart(this);

            updateShopBtns();
          });
          window.FarcadeSDK.on("toggle_mute", (data) => {
            this.sound.mute = data.isMuted; // Handle mute/unmute
          });

          updateShopBtns();
        }

        update(time, delta) {
          if (gameOver) {
            if (keys.R.isDown) restart(this);
            return;
          }

          // Manage wave timer
          let hours = Math.floor(gameTimeMinutes / 60);
          let minutes = Math.floor(gameTimeMinutes % 60);

          // Determine current phase
          isDay = hours >= 9 && hours < 15;

          // Pick clock speed based on phase
          let realSecondsPerGameMinute;
          if (isDay) {
            // 6 in-game hours in 15 real seconds
            realSecondsPerGameMinute = 15 / (6 * 60);
          } else {
            // 18 in-game hours in 20 real seconds
            realSecondsPerGameMinute = 45 / (18 * 60);
          }

          // Advance clock
          let minutesToAdd = delta / 1000 / realSecondsPerGameMinute;
          gameTimeMinutes = (gameTimeMinutes + minutesToAdd) % 1440; // wrap at 24h

          // Detect phase change for effects
          if (isDay !== lastIsDay) {
            lastIsDay = isDay;
            this.tweens.add({
              targets: this.vision,
              scaleX: isDay ? 2 : 1,
              scaleY: isDay ? 2 : 1,
              duration: 2000,
              ease: "Linear",
            });

            if (isDay) {
              // Play explosion for each zombie before clearing
              zombies.children.iterate((zombie) => {
                if (zombie && zombie.active) {
                  // this.zombieExplosionEmitter.emitParticleAt(zombie.x, zombie.y);
                  const p = this.add.particles("blood");
                  const emitter = p.createEmitter({
                    x: zombie.x,
                    y: zombie.y,
                    speed: { min: 80, max: 200 },
                    angle: { min: 0, max: 360 },
                    gravityY: 0,
                    lifespan: 400,
                    quantity: 12,
                    scale: { start: 0.9, end: 0 },
                    on: false,
                  });
                  emitter.explode(12, zombie.x, zombie.y);
                }
              });
              // increase waveNumber (for new day)
              waveNumber++;
              waveText.setText(`${isDay ? "Day" : "Wave"}: ${waveNumber}`);

              // --- Shop: slide in + open animation ---
              shop.setVisible(true);

              this.tweens.add({
                targets: shop,
                x: shop.x + 100,
                duration: 400,
                ease: "Power2",
                onComplete: () => {
                  shop.anims.play("shop-anim-open");
                },
              });

              this.time.delayedCall(2000, () => {
                shop.anims.play("shop-anim");
              });

              shopMenu.setVisible(true);
              stimmyBtn.setVisible(true);
              shotgunBtn.setVisible(true);

              zombies.clear(true, true);
            } else {
              shop.anims.play("shop-anim-close");
              this.time.delayedCall(2000, () => {
                this.tweens.add({
                  targets: shop,
                  x: shop.x - 100,

                  duration: 400,
                  ease: "Power2",
                  onComplete: () => {
                    shop.setVisible(false);
                  },
                });
              });

              shopMenu.setVisible(false);
              stimmyBtn.setVisible(false);
              shotgunBtn.setVisible(false);
              waveText.setText(`${isDay ? "Day" : "Wave"}: ${waveNumber}`);
              this.sound.play("music", { volume: 0.4 });
            }
          }

          // Apply textures and gameplay flags
          waveActive = !isDay;

          dayNightImage.setTexture(isDay ? "sun" : "moon");

          // Update clock text
          let clockText = hours.toString().padStart(2, "0") + ":" + minutes.toString().padStart(2, "0");
          timerText.setText(clockText);

          rt.visible = true; // Keep rt visible for transitions

          // Only handle keyboard input if joystick is not active
          if (!joystickActive) {
            let vx = 0,
              vy = 0;
            if (cursors.left.isDown || keys.A.isDown) vx -= player.speed;
            else if (cursors.right.isDown || keys.D.isDown) vx += player.speed;
            else if (cursors.up.isDown || keys.W.isDown) vy -= player.speed;
            else if (cursors.down.isDown || keys.S.isDown) vy += player.speed;

            if (vx !== 0 || vy !== 0) {
              footstepsTimer += delta;
              if (footstepsTimer >= 100) {
                this.sound.play("running", { volume: 0.05 });
                footstepsTimer = 0; // Reset the timer
              }
            }

            player.setVelocity(vx, vy);
          }

          // Update container to follow player
          if (playerContainer) {
            playerContainer.setPosition(player.x, player.y);
          }

          // Handle player animations based on direction
          const velocity = player.body.velocity;
          if (velocity.x > 0) {
            player.anims.play("right", true);
            playerContainer.setDepth(3);
          } else if (velocity.x < 0) {
            player.anims.play("left", true);
            playerContainer.setDepth(3);
          } else if (velocity.y < 0) {
            player.anims.play("up", true);
            playerContainer.setDepth(1);
          } else if (velocity.y > 0) {
            player.anims.play("down", true);
            playerContainer.setDepth(3);
          } else {
            player.anims.stop();
          }

          playerContainer.x = player.body.x;
          playerContainer.y = player.body.y;

          // Update gun rotation
          if (gun) {
            const pointer = this.input.activePointer;
            const angle = Phaser.Math.Angle.Between(player.x, player.y, pointer.worldX, pointer.worldY);
            if (pointer.worldX < playerContainer.x) {
              gun.setFlipY(true);
              gun.setFlipX(false);
              gun.setRotation(angle);
            } else {
              gun.setFlipX(false);
              gun.setFlipY(false);
              gun.setRotation(angle);
            }
          }

          // Spawn zombies only during active wave
          const currentDelay = Math.max(1500, 3000 - (waveNumber - 1) * 500);

          if (waveActive) {
            spawnTimer += delta;
            if (spawnTimer > currentDelay) {
              spawnTimer = 0;
              spawnZombie(this);
            }
          }

          // Zombies AI: move to player and handle animations
          zombies.getChildren().forEach((z) => {
            if (!z.active) return;
            const speed = z.baseSpeed;
            this.physics.moveToObject(z, player, speed);
            const angleToPlayer = Phaser.Math.Angle.Between(z.x, z.y, player.x, player.y);
            const direction = Phaser.Math.RadToDeg(angleToPlayer);
            if (z.zombieTypeSpawned === "kid") {
              if (direction > -45 && direction <= 45) z.anims.play("zombiekid-right", true);
              else if (direction > 45 && direction <= 135) z.anims.play("zombiekid-down", true);
              else if (direction > 135 || direction <= -135) z.anims.play("zombiekid-left", true);
              else z.anims.play("zombiekid-up", true);
            } else if (z.zombieTypeSpawned === "female") {
              if (direction > -45 && direction <= 45) z.anims.play("zombiefemale-right", true);
              else if (direction > 45 && direction <= 135) z.anims.play("zombiefemale-down", true);
              else if (direction > 135 || direction <= -135) z.anims.play("zombiefemale-left", true);
              else z.anims.play("zombiefemale-up", true);
            } else if (z.zombieTypeSpawned === "giant") {
              if (direction > -45 && direction <= 45) z.anims.play("zombiegiant-right", true);
              else if (direction > 45 && direction <= 135) z.anims.play("zombiegiant-down", true);
              else if (direction > 135 || direction <= -135) z.anims.play("zombiegiant-left", true);
              else z.anims.play("zombiegiant-up", true);
            } else {
              if (direction > -45 && direction <= 45) z.anims.play("zombie-right", true);
              else if (direction > 45 && direction <= 135) z.anims.play("zombie-down", true);
              else if (direction > 135 || direction <= -135) z.anims.play("zombie-left", true);
              else z.anims.play("zombie-up", true);
            }
          });

          // Handle invulnerability timer
          if (!canBeHit) {
            if (player._invulnTimer === undefined) player._invulnTimer = 0;
            player._invulnTimer -= delta;
            if (player._invulnTimer <= 0) {
              canBeHit = true;
              player.clearTint();
            }
          }

          // Check if still overlapping
          if (!this.physics.overlap(player, shop)) {
            isNearShop = false;
            hasPlayedShopVoice = false;
          }

          // Show/hide menu
          if (isDay) {
            shopMenu.setVisible(isNearShop);
            stimmyBtn.setVisible(isNearShop);
            shotgunBtn.setVisible(isNearShop);
          }

          // Update UI
          scoreText.setText("Score:" + score);
          cashText.setText("$ " + cash);
          healthBar.clear();
          healthBar.fillStyle(0xff0000, 1);
          healthBar.fillRect(16, 42, (health / 5) * 100, 10);

          if (health <= 0 && !gameOver) {
            // Display game over background
            zombies.clear(true, true);
            canBeHit = false;
            endStatsHeading.setVisible(true);
            endStatsText.setText(
              `Score: ${score}\nSurvived:${waveNumber - 1} days\nKills:${kills}\nCash: ${cash}\nWeapon: ${currentGun}`,
            );
            endStatsText.setVisible(true);
            endContinueBtn.setVisible(true);
            endbgblack.setVisible(true);
            endbg.setVisible(true);
            window.FarcadeSDK.singlePlayer.actions.hapticFeedback();
            if (!hasPlayedDeathscream) {
              // Play the selected sound effect
              this.sound.play("playerdeath", { volume: 0.2 });
              hasPlayedDeathscream = true; // Set the flag to true
            }
          }

          if (this.vision) {
            this.vision.x = player.x; // Ensure it's centered on player
            this.vision.y = player.y;
          }
        }
      }

      const config = {
        type: Phaser.AUTO,
        parent: "game-container",
        width: WIDTH,
        height: HEIGHT,
        backgroundColor: "#2b2b2b",
        physics: {
          default: "arcade",
          arcade: {
            debug: false,
            gravity: { y: 0 },
          },
        },
        scale: {
          mode: Phaser.Scale.FIT,
          autoCenter: Phaser.Scale.CENTER_BOTH,
        },
        pixelArt: true,

        scene: [BootScene, LoadingScene, GameScene],
      };

      // Start Phaser
      new Phaser.Game(config);
    </script>
  </body>
</html>
